<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include ../../../layout/rts/head %>

    <title>Nouveau compte - MaRTS - rts.ch</title>

    <script src="https://www.google.com/recaptcha/api.js?hl=fr" async defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/locale/fr-ch.js" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>

    <script src="<%= link('/js/password-score.js') %>" async defer></script>

</head>
<body class="rts-body web">

<main class="container">
    <div class="rts-form-container">

        <div class="top-image">
            <img src="<%= link('/img/logo_marts-black.svg')%>">
        </div>

        <h1 class="rts-form-title">Créer mon compte</h1>

        <p>Renseignez les champs présents ci-dessous afin de créer un compte.</p>

        <form id="new-accound-form" class="rts-form" method="post" action="<%= target %>">

            <div class="text-danger error-message"><%= message %></div>

            <div class="form-group">
                <input type="text" id="create_account_birthdate" name="date_of_birth" class="form-control custom-datepicker" placeholder="Date de naissance (JJ.MM.AAAA)" value="<%= date_of_birth %>" required/>
            </div>

            <div class="form-group">
                <label class="radio-inline">
                    <input type="radio" class="signup_gender" name="gender" value="male" required> Homme
                </label>
                <label class="radio-inline">
                    <input type="radio" class="signup_gender" name="gender" value="female" required> Femme
                </label>
                <label class="radio-inline">
                    <input type="radio" class="signup_gender" name="gender" value="other" checked="checked" required> Non renseigné
                </label>
            </div>

            <div class="form-group">
                <input type="email" id="create_account_email" name="email" value="<%= email %>" class="form-control" placeholder="Adresse email (identifiant)" required>
            </div>

            <div class="form-group">
                <input type="password" id="create_account_password" name="password" class="form-control password-complexity" placeholder="Mot de passe" required>

                <div class="password-handler">
                    <div class="password-bar">
                        <span class="password-progress"></span>
                    </div>
                    <div class="password-complexity-explanation"> Pour rendre votre mot de
                        passe plus sécurisé, vous pouvez ajouter :
                        <ul>
                            <li>Plus de caractères</li>
                            <li>Des lettres majuscules</li>
                            <li>Des chiffres</li>
                            <li>Des caractères spéciaux (ex: !?+#...)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="align-left">
                <p>
                    <input id="create_conditions" type="checkbox" name="create_conditions" required>
                    <label for="create_conditions">
                        J'accepte les&nbsp;<a class="form-link" href="//www.rtsentreprise.ch/conditions-generales/" target="_blank">conditions d'utilisation</a>
                    </label>
                </p>
                <p>
                    <input id="create_charte" type="checkbox" name="create_charte" required>
                    <label for="create_charte">
                        J'accepte la&nbsp;<a class="form-link" href="//www.rts.ch/entreprise/a-propos/8994006-charte-de-confidentialite.html" target="_blank">charte de confidentialité</a>
                    </label>
                </p>
            </div>

            <div class="g-recaptcha" data-sitekey="<%= config.limiter.parameters.recaptcha.site_key %>"></div>

            <input class="btn btn-default btn-rts" type="submit" value="Continuer">

        </form>

        <div class="rts-form-links">
            Vous avez déjà un compte ? <a href="<%= login %>">Connectez-vous !</a>
        </div>

    </div>
</main>

<script>
    $(document).ready(function () {
        $("#new-accound-form").validate({
            errorClass: 'text-danger form-error',
            ignore: ".ignore",
            messages: {
                date_of_birth: 'Veuillez saisir votre date de naissance',
                email: {
                    required: 'Veuillez saisir votre email',
                    email: 'Veuillez saisir un email valide'
                },
                password: 'Veuillez saisir un mot de passe valide',
                create_conditions: 'Veuillez accepter nos conditions d\'utilisation',
                create_charte : 'Veuillez accepter notre charte de confidentialité',
                'g-recaptcha-response':'Veuillez accepter notre charte de confidentialité111'
            },
            errorPlacement: function(error, element) {
                element.parent().prepend(error);
            },
            submitHandler: function(form, event) {

                var dateOfBirth = form.querySelector("#create_account_birthdate").value,
                    instant = moment(dateOfBirth, 'dd.MM.yyyy'),
                    gender = $('input[name=gender]:checked', form).val(),
                    email = form.querySelector("#create_account_email").value,
                    password = form.querySelector("#create_account_password").value,
                    recaptchaToken = getRecaptchaToken();

                if (!instant.isValid()) {
                    return showErrorMessage(form, 'form', 'Veuillez saisir une date de naissance valide');
                } else if (recaptchaToken.length === 0) {
                    return showErrorMessage(form, 'form', 'Veuillez cocher le champ "Je ne suis pas un robot"');
                }

                form.submit();
            }
        });
    });

    $(document).on('keyup', '.password-complexity', function () {

        var $this = $(this),
            $passwordExplanation = $(this).next(".password-handler"),
            $progressBar = $passwordExplanation.find(".password-bar"),
            $progress = $passwordExplanation.find(".password-progress"),
            $explanation = $passwordExplanation.find(".password-complexity-explanation"),
            strPassword = $this.val(),
            base = getBase(strPassword),
            score = getScore(strPassword);

        $progressBar.show();

        if (strPassword.length === 0){
            $progressBar.hide();
            $explanation.hide();
        } else if(strPassword.length < MIN_PASSWORD_LENGTH) {
            $explanation.show();
            $progress.css('background-color', 'red');
            $progress.css('width', '1%');
        } else if(base !== 0 && score < 0.1) {
            $explanation.show();
            $progress.css('background-color', 'red');
            $progress.css('width', '10%');
        } else if(base !== 0 && score < 0.2) {
            $explanation.show();
            $progress.css('background-color', 'orange');
            $progress.css('width', '20%');
        } else if(base !== 0 && score < 0.35) {
            $explanation.show();
            $progress.css('background-color', 'orange');
            $progress.css('width', '35%');
        } else if(base !== 0 && score < 0.5) {
            $explanation.show();
            $progress.css('background-color', 'orange');
            $progress.css('width', '50%');
        } else if(base !== 0 && score < 0.75) {
            $explanation.hide();
            $progress.css('background-color', 'green');
            $progress.css('width', '75%');
        } else if(base !== 0 && score <= 1) {
            $explanation.hide();
            $progress.css('background-color', 'green');
            $progress.css('width', '100%');
        }

        return base === 0 || score > 0.2;
    });

    function showErrorMessage(form, type, message) {
        $(form).find(".error-message").empty().append(message);
        return false;
    }

    function getRecaptchaToken() {
        var isRecaptchaLoaded = typeof grecaptcha !== "undefined";
        return isRecaptchaLoaded ? grecaptcha.getResponse() : "";
    }

</script>

</body>
</html>